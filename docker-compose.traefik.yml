# =============================================================================
# Docker Compose Traefik 生产环境配置
# 用途：在生产服务器上作为公共入口，处理 HTTPS 和域名路由
# 使用方法：docker compose -f docker-compose.traefik.yml up -d
# 注意：此文件独立运行，不会自动与其他 compose 文件合并
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Traefik 反向代理
  # 作用：
  #   1. 处理所有入站流量
  #   2. 自动申请和续期 Let's Encrypt SSL 证书
  #   3. 根据域名将请求转发到对应服务
  # ---------------------------------------------------------------------------
  traefik:
    image: traefik:3.6.4
    ports:
      # HTTP 端口 - 用于重定向到 HTTPS
      - 80:80
      # HTTPS 端口 - 主要的安全访问入口
      - 443:443
    restart: always  # 服务器重启后自动启动
    labels:
      # 启用 Traefik 代理此服务
      - traefik.enable=true
      # 使用 traefik-public 网络
      - traefik.docker.network=traefik-public
      # 定义 Dashboard 服务端口
      - traefik.http.services.traefik-dashboard.loadbalancer.server.port=8080

      # ----- HTTP 路由（用于重定向到 HTTPS）-----
      - traefik.http.routers.traefik-dashboard-http.entrypoints=http
      - traefik.http.routers.traefik-dashboard-http.rule=Host(`traefik.${DOMAIN?Variable not set}`)

      # ----- HTTPS 路由（主访问入口）-----
      - traefik.http.routers.traefik-dashboard-https.entrypoints=https
      - traefik.http.routers.traefik-dashboard-https.rule=Host(`traefik.${DOMAIN?Variable not set}`)
      - traefik.http.routers.traefik-dashboard-https.tls=true
      # 使用 Let's Encrypt 证书解析器
      - traefik.http.routers.traefik-dashboard-https.tls.certresolver=le
      # 使用 Traefik 内置的 Dashboard 服务
      - traefik.http.routers.traefik-dashboard-https.service=api@internal

      # ----- HTTPS 重定向中间件 -----
      # 将 HTTP 请求永久重定向到 HTTPS
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true
      # 应用重定向中间件
      - traefik.http.routers.traefik-dashboard-http.middlewares=https-redirect

      # ----- HTTP Basic 认证中间件 -----
      # 保护 Dashboard，需要用户名和密码
      # 使用环境变量 USERNAME 和 HASHED_PASSWORD
      - traefik.http.middlewares.admin-auth.basicauth.users=${USERNAME?Variable not set}:${HASHED_PASSWORD?Variable not set}
      # 应用认证中间件到 Dashboard
      - traefik.http.routers.traefik-dashboard-https.middlewares=admin-auth

    volumes:
      # 挂载 Docker socket，让 Traefik 能够读取容器信息
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # 挂载证书存储卷（持久化 Let's Encrypt 证书）
      - traefik-public-certificates:/certificates

    command:
      # 启用 Docker 提供者，自动发现容器
      - --providers.docker
      # 默认不暴露所有服务
      - --providers.docker.exposedbydefault=false
      # 创建 HTTP 入口点（80 端口）
      - --entrypoints.http.address=:80
      # 创建 HTTPS 入口点（443 端口）
      - --entrypoints.https.address=:443
      # ----- Let's Encrypt 证书配置 -----
      # 设置证书申请邮箱（必填）
      - --certificatesresolvers.le.acme.email=${EMAIL?Variable not set}
      # 证书存储路径
      - --certificatesresolvers.le.acme.storage=/certificates/acme.json
      # 使用 TLS 挑战方式验证域名所有权
      - --certificatesresolvers.le.acme.tlschallenge=true
      # 启用访问日志
      - --accesslog
      # 启用 Traefik 日志
      - --log
      # 启用 Dashboard 和 API
      - --api

    networks:
      # 加入公共网络，与其他需要外网访问的服务通信
      - traefik-public

# =============================================================================
# 数据卷定义
# =============================================================================
volumes:
  # Let's Encrypt 证书持久化存储
  # 即使容器重建，证书也会保留，避免频繁申请
  traefik-public-certificates:

# =============================================================================
# 网络定义
# =============================================================================
networks:
  # 使用外部的 traefik-public 网络
  # 需要先手动创建：docker network create traefik-public
  traefik-public:
    external: true
